import pytest  
import archnemesis as ans
import numpy as np
import os

def test_thermal_emission_cirs():  
    '''
    Jupiter thermal emission test against NEMESIS
    '''
    
    os.chdir('files/Jupiter_CIRS_nadir_thermal_emission/') #Changing directory to read files
    runname = 'cirstest'
    
    #Reading the input files
    Atmosphere,Measurement,Spectroscopy,Scatter,Stellar,Surface,CIA,Layer,Variables,Retrieval = ans.Files.read_input_files(runname,Fortran=False)
    
    #Calculating forward model with CIRSrad
    ForwardModel = ans.ForwardModel_0(runname=runname, Atmosphere=Atmosphere,Surface=Surface,Measurement=Measurement,Spectroscopy=Spectroscopy,Stellar=Stellar,Scatter=Scatter,CIA=CIA,Layer=Layer,Variables=Variables)
    SPECONV_cirsrad = ForwardModel.nemesisfm()
    calculation_cirsrad = SPECONV_cirsrad[:,0]
    
    #Calculating forward model with CIRSradg
    SPECONV_cirsradg,_ = ForwardModel.nemesisfmg()
    calculation_cirsradg = SPECONV_cirsradg[:,0]
    
    expected_nemesis = np.array([4.8584261e-09, 7.3546157e-09, 1.1448862e-08, 1.6160637e-08, 2.1053524e-08,
                                2.5728575e-08, 2.9602468e-08, 3.2811268e-08, 4.3521572e-08, 5.5772129e-08,
                                6.5849976e-08, 7.3240631e-08, 8.3390190e-08, 9.2134087e-08, 1.0044071e-07,
                                1.0678105e-07, 1.1343881e-07, 1.1549196e-07, 1.2531892e-07, 1.4620917e-07,
                                1.6264473e-07, 1.7962228e-07, 1.9288992e-07, 2.0416275e-07, 2.1074971e-07,
                                2.2027789e-07, 2.2266154e-07, 2.2305901e-07, 2.4031033e-07, 2.6767789e-07,
                                2.9259265e-07, 3.1068597e-07, 3.2589871e-07, 3.3453671e-07, 3.4601343e-07,
                                3.5169019e-07, 3.4915579e-07, 3.4144742e-07, 3.6189087e-07, 3.9845914e-07,
                                4.2636136e-07, 4.4908469e-07, 4.6496048e-07, 4.8008325e-07, 4.8607019e-07,
                                4.8612775e-07, 4.7288797e-07, 4.5949658e-07, 4.9488187e-07, 5.4081171e-07,
                                5.7139917e-07, 5.9743573e-07, 6.1747736e-07, 6.3028912e-07, 6.3479559e-07,
                                6.2755280e-07, 5.9436615e-07, 5.7073480e-07, 6.2801385e-07, 6.8389581e-07,
                                7.2138861e-07, 7.4936548e-07, 7.6929932e-07, 7.8037451e-07, 7.8282648e-07,
                                7.6146552e-07, 6.9230811e-07, 6.7543353e-07, 7.6866937e-07, 8.3855658e-07,
                                8.7873480e-07, 9.0911798e-07, 9.2920862e-07, 9.3920532e-07, 9.3839355e-07,
                                8.9851105e-07, 7.8122192e-07, 7.8696436e-07, 9.2957825e-07, 1.0037038e-06,
                                1.0499105e-06, 1.0827148e-06, 1.1033911e-06, 1.1090631e-06, 1.1063834e-06,
                                1.0004811e-06, 8.4869373e-07, 9.2497845e-07, 1.1164567e-06, 1.1966298e-06,
                                1.2438824e-06, 1.2778672e-06, 1.2954698e-06, 1.2930934e-06, 1.2831893e-06,
                                1.0706979e-06, 9.5264032e-07, 1.0764868e-06, 1.3135985e-06, 1.3970815e-06,
                                1.4377687e-06, 1.4615624e-06, 1.4683627e-06, 1.4729186e-06, 1.3863530e-06,
                                1.1112964e-06, 1.0892354e-06, 1.2808145e-06, 1.5100726e-06, 1.5500964e-06,
                                1.5637694e-06, 1.5710072e-06, 1.5696403e-06, 1.5613228e-06, 1.3672264e-06,
                                1.2307899e-06, 1.2651921e-06, 1.4578094e-06, 1.5720677e-06, 1.5743357e-06,
                                1.5702667e-06, 1.5635206e-06, 1.5542504e-06, 1.4899187e-06, 1.3873461e-06,
                                1.3215043e-06, 1.3458383e-06, 1.4491620e-06, 1.4914265e-06, 1.4772347e-06,
                                1.4617134e-06, 1.4449102e-06, 1.4224144e-06, 1.3886283e-06, 1.3546263e-06,
                                1.3173374e-06, 1.3182119e-06, 1.3266578e-06, 1.3092109e-06, 1.2875592e-06,
                                1.2651860e-06, 1.2420231e-06, 1.2180204e-06, 1.1936686e-06, 1.1677655e-06,
                                1.1430958e-06, 1.1220846e-06, 1.0999083e-06, 1.0761125e-06, 1.0523517e-06,
                                1.0287583e-06, 1.0054186e-06, 9.8237390e-07, 9.5967468e-07, 9.3741150e-07,
                                9.1562036e-07, 8.9442218e-07, 8.7381378e-07, 8.5369598e-07, 8.3420624e-07,
                                8.1535730e-07, 7.9717535e-07, 7.7967236e-07, 7.6180219e-07, 7.4443066e-07,
                                7.2856830e-07, 7.1450586e-07, 7.0088660e-07, 6.8765540e-07, 6.7538202e-07,
                                6.6267737e-07, 6.4999603e-07, 6.3933038e-07, 6.3036133e-07, 6.2214221e-07,
                                6.1341302e-07, 6.0403436e-07, 5.9468842e-07, 5.8671277e-07, 5.8059766e-07,
                                5.7498517e-07, 5.6939032e-07, 5.6374298e-07, 5.5805457e-07, 5.5301721e-07,
                                5.4850867e-07, 5.4482281e-07, 5.4162775e-07, 5.3824603e-07, 5.3478845e-07,
                                5.3157739e-07, 5.2859882e-07, 5.2583746e-07, 5.2328076e-07, 5.2091199e-07,
                                5.1872162e-07, 5.1669647e-07, 5.1482220e-07, 5.1308667e-07, 5.1148004e-07,
                                5.0999289e-07, 5.0861325e-07, 5.0732758e-07, 5.0612430e-07, 5.0499158e-07,
                                5.0391702e-07, 5.0289008e-07, 5.0189755e-07, 5.0092734e-07, 4.9996619e-07,
                                4.9899921e-07, 4.9801270e-07, 4.9699310e-07, 4.9592587e-07, 4.9479718e-07,
                                4.9358936e-07, 4.9228970e-07, 4.9088162e-07, 4.8934726e-07, 4.8767184e-07,
                                4.8583951e-07, 4.8383594e-07, 4.8164798e-07, 4.7925629e-07, 4.7664539e-07,
                                4.7380594e-07, 4.7072073e-07, 4.6737854e-07, 4.6376920e-07, 4.5988043e-07,
                                4.5571075e-07, 4.5124490e-07, 4.4647473e-07, 4.4141516e-07, 4.3604837e-07,
                                4.3037637e-07, 4.2441125e-07, 4.1814981e-07, 4.1160321e-07, 4.0478369e-07,
                                3.9768237e-07, 3.9036606e-07, 3.8280203e-07, 3.7501981e-07, 3.6706396e-07,
                                3.5892419e-07, 3.5064951e-07, 3.4224255e-07, 3.3375659e-07, 3.2519550e-07,
                                3.1659717e-07, 3.0798233e-07, 2.9939157e-07, 2.9082971e-07, 2.8234537e-07,
                                2.7393796e-07, 2.6566003e-07, 2.5750650e-07, 2.4951070e-07, 2.4169688e-07,
                                2.3406468e-07, 2.2663484e-07, 2.1941837e-07, 2.1242567e-07, 2.0566843e-07,
                                1.9914946e-07, 1.9287065e-07, 1.8683585e-07, 1.8104300e-07, 1.7549232e-07,
                                1.7018111e-07, 1.6510556e-07, 1.6025978e-07, 1.5564037e-07, 1.5123787e-07,
                                1.4704872e-07, 1.4306297e-07, 1.3927217e-07, 1.3566867e-07, 1.3218730e-07,
                                1.2883455e-07, 1.2570744e-07, 1.2280119e-07, 1.2002447e-07, 1.1738745e-07,
                                1.1488692e-07, 1.1243835e-07, 1.1007292e-07, 1.0785621e-07, 1.0580288e-07,
                                1.0386935e-07, 1.0197364e-07, 1.0009019e-07, 9.8244209e-08, 9.6497612e-08,
                                9.4868713e-08, 9.3328484e-08, 9.1829971e-08, 9.0342514e-08, 8.8904350e-08,
                                8.7514183e-08, 8.6163330e-08, 8.4884987e-08, 8.3670090e-08, 8.2473732e-08,
                                8.1293228e-08, 8.0150070e-08, 7.9043312e-08, 7.7971992e-08, 7.6935318e-08,
                                7.5932571e-08, 7.4962944e-08, 7.4025543e-08, 7.3120750e-08, 7.2247086e-08,
                                7.1403999e-08, 7.0590927e-08, 6.9807411e-08, 6.9052834e-08, 6.8326630e-08,
                                6.7628235e-08, 6.6957298e-08, 6.6312515e-08, 6.5694862e-08, 6.5102898e-08,
                                6.4538475e-08, 6.3996632e-08, 6.3478455e-08, 6.2988064e-08, 6.2515633e-08,
                                6.2088760e-08, 6.1650951e-08, 6.1262135e-08, 6.0905540e-08, 6.0540550e-08,
                                6.0268284e-08, 5.9946522e-08, 5.9796078e-08, 5.9612347e-08, 5.9300888e-08,
                                5.9267666e-08, 5.9085258e-08, 5.9296494e-08, 5.8871094e-08, 5.9474415e-08,
                                6.1476555e-08, 5.8831402e-08, 5.9787106e-08, 5.9278301e-08, 5.9925106e-08,
                                5.9423576e-08, 6.0243343e-08, 6.0219692e-08, 5.9840992e-08, 5.9907806e-08,
                                5.9096317e-08, 6.1712818e-08, 6.0109982e-08, 6.0307335e-08, 5.8610394e-08,
                                5.7818413e-08, 5.7526470e-08, 1.1267761e-07, 8.2236023e-08, 6.1923225e-08,
                                6.2387665e-08, 5.9859581e-08, 6.0599319e-08, 6.0318874e-08, 6.0667576e-08,
                                5.9548794e-08, 6.1108742e-08, 6.0564842e-08, 6.0204086e-08, 6.0163651e-08,
                                6.0447464e-08, 6.0519470e-08, 5.9920025e-08, 5.9612988e-08, 5.9203617e-08,
                                5.8764439e-08, 5.6933647e-08, 5.9622971e-08, 5.5990307e-08, 5.7534927e-08,
                                5.7165520e-08, 5.5671062e-08, 5.3128845e-08, 5.5280167e-08, 6.0398746e-08,
                                5.5639328e-08, 5.1634716e-08, 5.0014988e-08, 5.2156898e-08, 5.1099960e-08,
                                4.6864136e-08, 4.3886826e-08, 5.1868553e-08, 5.6965309e-08, 5.6471226e-08,
                                5.1457512e-08, 4.2889824e-08, 4.4504360e-08, 4.5121334e-08, 3.9491467e-08,
                                3.7921131e-08, 3.9875168e-08, 5.0381966e-08, 5.0049747e-08, 5.2558193e-08,
                                4.8259502e-08, 3.5017765e-08, 3.9427307e-08, 3.5923790e-08, 3.0411037e-08,
                                3.2780293e-08, 4.3119991e-08, 4.6935379e-08, 4.7211403e-08, 4.4291142e-08,
                                4.1636143e-08, 2.8973530e-08, 3.0848419e-08, 2.5315392e-08, 2.0787739e-08,
                                2.7715296e-08, 3.7397213e-08, 4.1790646e-08, 4.2858734e-08, 3.8270470e-08,
                                3.5494709e-08, 2.2265303e-08, 2.2752110e-08, 2.1800795e-08, 1.9849861e-08,
                                3.2848110e-08, 3.9026699e-08, 4.1106171e-08, 4.0123203e-08, 3.3937340e-08,
                                3.0632933e-08, 1.8829010e-08, 1.7220194e-08, 1.5917923e-08, 1.5449844e-08,
                                2.5513193e-08, 3.1137106e-08, 3.3521545e-08, 3.3018154e-08, 2.7516844e-08,
                                2.4647093e-08, 1.5184879e-08, 1.3395007e-08, 2.2327030e-08, 2.7217796e-08,
                                2.8691757e-08, 2.8621717e-08, 2.5388609e-08, 2.1054914e-08, 1.7606556e-08,
                                1.3957446e-08, 1.0211869e-08, 8.1733809e-09, 6.7937598e-09, 8.3478527e-09,
                                1.1573672e-08, 1.6230263e-08, 2.0121946e-08, 2.1663843e-08, 1.9980810e-08,
                                1.8230742e-08, 1.1890425e-08, 9.5246973e-09, 9.2556400e-09, 1.1065035e-08,
                                1.6165781e-08, 1.7632214e-08, 1.5750751e-08, 1.1464599e-08, 8.4838238e-09,
                                6.2236500e-09, 4.8049302e-09, 7.1582775e-09, 7.7674055e-09, 9.3096342e-09,
                                1.4150698e-08, 1.7131689e-08, 1.8711870e-08, 1.9483126e-08, 1.8999777e-08,
                                1.7945910e-08, 1.4354152e-08, 9.8762531e-09, 6.2064862e-09, 5.0584679e-09,
                                9.5887098e-09, 1.3361338e-08, 1.5091534e-08, 1.3715826e-08, 1.1365108e-08,
                                9.0687866e-09, 4.8882093e-09, 5.7919140e-09, 5.1579905e-09, 4.7245641e-09,
                                9.2626247e-09, 1.1780839e-08, 1.4437984e-08, 1.2953341e-08, 1.1373133e-08,
                                7.4984097e-09, 4.2963314e-09, 5.9966116e-09, 4.4368844e-09, 3.4718609e-09,
                                5.2454882e-09, 9.5912151e-09, 9.9658785e-09, 8.6543312e-09, 7.8286433e-09,
                                4.4987411e-09, 3.3873484e-09, 4.8543220e-09, 5.2189083e-09, 4.2471762e-09,
                                5.0994453e-09, 9.9852104e-09, 1.0532121e-08, 9.2893705e-09, 7.3350539e-09,
                                3.4588881e-09, 3.8039389e-09, 6.1091685e-09, 6.3032598e-09, 5.2779427e-09,
                                3.7059147e-09, 7.4343600e-09, 9.3989058e-09, 9.1449766e-09, 5.4231677e-09,
                                3.0204649e-09, 6.0768661e-09, 6.7856798e-09, 7.9671254e-09, 7.6658678e-09,
                                6.2431135e-09, 7.7412238e-09, 1.1611691e-08, 9.4372959e-09, 3.8338332e-09,
                                6.3368778e-09, 9.3209095e-09, 1.1764165e-08, 1.0807606e-08, 1.2313779e-08,
                                9.1647396e-09, 6.4297590e-09, 9.0847874e-09, 4.8162494e-09, 5.0889626e-09,
                                1.0565254e-08, 1.4812076e-08, 1.6440260e-08, 1.4631531e-08, 1.5946937e-08,
                                1.4290399e-08, 1.2446825e-08, 9.5210819e-09, 5.9844255e-09, 1.2170580e-08,
                                2.2884439e-08, 2.6404135e-08, 2.9819027e-08, 2.1934074e-08, 1.7990387e-08,
                                1.8409866e-08, 1.1889088e-08, 6.8026099e-09, 1.5150228e-08, 2.1101385e-08,
                                1.6887077e-08, 3.4432682e-08, 1.9378185e-08, 2.2937487e-08, 2.0464197e-08,
                                1.8458294e-08, 9.4163113e-09, 2.0771553e-08, 3.1603844e-08, 2.7017204e-08,
                                1.1651676e-08, 2.0113413e-08, 3.1608503e-08, 1.3124151e-08, 2.4769722e-08,
                                1.5489309e-08, 1.3924122e-08, 1.4551901e-08, 1.2348675e-08, 7.2600050e-09,
                                2.0330894e-08, 2.2671549e-08, 9.9048252e-09, 4.9973583e-09, 1.2932522e-08,
                                1.3094554e-08, 3.2627735e-09, 3.8407443e-09, 2.1846564e-09, 3.4685094e-09,
                                4.8679838e-09, 3.8054590e-09, 2.5731137e-09, 2.4582245e-09, 1.9776840e-09,
                                2.4239511e-09, 3.1358364e-09, 2.0440836e-09, 2.5029917e-09, 2.4378867e-09,
                                2.1676559e-09, 4.3747234e-09, 3.5441055e-09, 1.3862363e-09, 4.4713306e-09,
                                3.3564324e-09, 1.9605520e-09, 3.8623242e-09, 5.6331458e-09, 4.6725211e-09,
                                3.7400744e-09, 3.5188894e-09, 6.2345238e-09, 5.1939368e-09, 9.5662713e-10,
                                5.1920180e-09, 4.4947948e-09, 1.3401276e-09, 3.6991100e-09, 6.3904181e-09,
                                1.2360828e-09, 3.9779282e-09, 6.3854074e-09, 1.5106345e-09, 3.3721461e-09,
                                6.0694051e-09, 6.9554329e-09, 5.3003449e-09, 7.4297953e-09, 1.0321697e-08,
                                1.5329431e-08, 6.8853636e-09, 8.6020756e-10, 2.6103129e-09, 1.3048942e-09,
                                6.3421232e-10, 2.3838668e-09, 1.3236219e-09, 2.7644055e-09, 4.0111141e-09,
                                1.3650000e-09, 4.8419251e-09, 1.7402623e-09, 2.3191605e-09, 5.9516773e-09,
                                1.5270556e-09, 5.0298882e-09, 2.4463601e-09, 3.6493835e-09, 5.0955243e-09,
                                1.1698582e-09, 5.0181150e-09, 1.8624843e-09, 2.6443036e-09, 2.2610385e-09,
                                2.1515768e-09, 2.1496334e-09, 1.6903979e-09, 1.6187227e-09, 9.3860918e-10,
                                1.2248980e-09, 9.2515904e-10, 1.1712694e-09, 5.5587405e-10, 9.2409402e-10,
                                8.1522131e-10, 6.5276933e-10, 1.1893343e-09, 2.4583397e-09, 1.0952785e-09,
                                2.8014214e-09, 1.2821060e-09, 4.0617671e-09, 1.7947460e-08, 2.2128742e-08,
                                9.0081511e-09, 6.7242318e-10, 3.4550025e-09])

    
    # Use a NumPy comparison for arrays
    assert np.allclose(calculation_cirsrad, expected_nemesis, rtol=5.0e-2)
    assert np.allclose(calculation_cirsradg, expected_nemesis, rtol=5.0e-2)